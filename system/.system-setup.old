#!/bin/sh

SETUP_TYPE=$1
[ -z "$SETUP_TYPE" ] && SETUP_TYPE="desktop";

if [ $SETUP_TYPE != "desktop" ]; then
    if [ $SETUP_TYPE != "server" ]; then
        echo "Usage: sudo ./system-setup [desktop|server]\n"
        echo "Failed setting up system - unknown type \"${SETUP_TYPE}\"";
        exit 1;
    fi;
fi;

if [ ! -e /root/.profile ]; then
    echo "Usage: sudo ./system-setup [desktop|server]\n"
    echo "Failed setting up ${SETUP_TYPE} - run with sudo";
    exit 1;
fi;

###
## Disable swap
###

if [ $SETUP_TYPE="desktop" ]; then

    echo "Disabling swap"

    # Turn off swap
    swapoff -a

    # Remove line in fstab with swap
    cat /etc/fstab | grep -v "\\s\\+none\\s\\+swap" > /etc/fstab

fi;

###
## Update stuff
###

apt-get -y update
apt-get -y upgrade --show-upgraded


###
## Standard pkgs
###

# Base tools
apt-get install -y build-essentials
[ -z "$(which git)" ] && apt-get install -y git;
apt-get install -y zsh
apt-get install -y openssl
apt-get install -y apt-transport-https

if [ $SETUP_TYPE="desktop" ]; then

    apt-get install -y dconf-tools

    # UI/media
    apt-get install -y smplayer
    apt-get install -y ttf-mscorefonts-installer
    apt-get install -y pcmanfm

fi;

# -- Dev lang tools

# Ruby + SASS
./ruby-and-sass-setup
echo "Setup ruby & SASS..."
[ -f "ruby-and-sass-setup" ] && ./ruby-and-sass-setup || echo "File missing - ruby-and-sass-setup";


# -- Dev UI tools

if [ $SETUP_TYPE="desktop" ]; then

    # Sublime text
    wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | sudo apt-key add -
    echo "deb https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime-text.list
    apt-get update
    apt-get install -y sublime-text

fi;

# Servers
apt-get install -y redis-server
apt-get install -y nginx
apt-get install -y postgresql
update-rc.d postgresql enable
service postgresql start

if [ $SETUP_TYPE="server" ]; then

    apt-get install -y letsencrypt

fi;

###
## Get the scripts where the need to be
###

# For current user
[ ! -s $HOME/bin ] && mkdir $HOME/bin;
cp $HOME/scripts/.{zshrc,jshintrc,toprc,npmrc} $HOME/
cp $HOME/scripts/{dec,enc,nodeswap,pgb,pgr} $HOME/bin/

# For root
[ ! -s /root/bin ] && mkdir /root/bin;
cp $HOME/scripts/.{zshrc,jshintrc,toprc,npmrc} /root/
cp $HOME/scripts/{dec,enc,nodeswap,pgb,pgr} /root/bin/


###
## Terminal setup-ish
###

# nano syntax highlighting
echo "Setup nano syntax highlighting..."
[ -f "setup-nano-syntax-highlighting" ] && ./setup-nano-syntax-highlighting || echo "File missing - setup-nano-syntax-highlighting";


###
## Some GNOME settings
###

if [ $SETUP_TYPE="desktop" ]; then

    echo "Gnome settings (keyboard delay, scrollbars, etc)"

    # Keyboard repeat speed (interval in ms between characters)
    gsettings set org.gnome.desktop.peripherals.keyboard repeat-interval 30

    # Keyboard input delay
    gsettings set org.gnome.desktop.peripherals.keyboard delay 210

    # Hopefully disable overlay scrollbars
    ENV_FILE_CONTENT=$(cat /etc/environment | grep -v "^GTK_OVERLAY_SCROLLING=.*$")
    # Testing
    echo $ENV_FILE_CONTENT > /tmp/old_env_file
    # When finished test, uncomment below
    # echo "${ENV_FILE_CONTENT}\nGTK_OVERLAY_SCROLLING=0" > /etc/environment

fi;

###
## Create the new ssh keys
###



